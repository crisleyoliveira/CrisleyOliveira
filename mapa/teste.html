<!DOCTYPE html>
<html lang='en'>
<head>
    <!-- META -->
    <meta charset='utf-8' />
    <meta name='viewport' content='initial-scale=1, maximum-scale=1, user-scalable=no' />
    <meta name="format-detection" content="telephone=no">

    <!-- TITLE -->
    <title>Lisboa</title>

    <!-- STYLE SHEETS -->
    <link href='https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,600' rel='stylesheet'>
    <link rel='stylesheet' href='style.css' type='text/css' />
    <link rel='stylesheet' href='d3.slider.css' type='text/css' />

    <!-- MapBox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
    <!-- HEADER -->
    <div id='header'>
        <!-- HEADER/TITLE -->
        <div id='title'>
            <span class='desktop'>Lisboa&nbsp;Airbnb&nbsp;Explorer</span>
        </div>
    </div>

    <!-- MB Map -->
    <div id='map'></div>

    <!-- Turf.js -->
<script src='https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js'></script>


    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3Jpc2xleW5vIiwiYSI6ImNsanZqc3V5czE3emYzdG4wdnl5emRkOGsifQ.1npueBKtBTbhxx7Wyko1Mw';

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [-9.1393, 38.7223], // Coordenadas de Lisboa
            zoom: 12,
            pitch: 60, // Ajuste o valor para definir a inclinação 3D adequada
            bearing: 20,
            antialias: true
        });

        // Function to load and process the GeoJSON data
        function loadData() {
            fetch('lisboa.geojson')
                .then(response => response.json())
                .then(data => clusterLocations(data));
        }

        // Function to perform spatial clustering using Turf.js
        function clusterLocations(data) {
            var clustered = turf.clustersDbscan(data, { distance: 0.1, minPoints: 2 });
            var clusteredData = turf.collect(clustered, 'cluster', 'clusterId', 'features');
            addBarsToMap(clusteredData);
        }

        // Function to add chart bars to the map
        function addBarsToMap(data) {
            map.on('load', function () {
                // Add a new layer for the chart bars
                map.addSource('airbnbData', {
                    type: 'geojson',
                    data: data
                });

                map.addLayer({
                    id: 'bars',
                    type: 'fill-extrusion',
                    source: 'airbnbData',
                    paint: {
                        'fill-extrusion-color': 'green',
                        'fill-extrusion-height': ['*', 5, ['length', ['get', 'features']]],
                        'fill-extrusion-base': 0,
                        'fill-extrusion-opacity': 0.8,
                        'fill-extrusion-vertical-gradient': true
                    }
                });
            });
        }

        loadData();
    </script>
</body>
</html>
