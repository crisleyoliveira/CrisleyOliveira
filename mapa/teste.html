<!DOCTYPE html>
<html lang='en'>
<head>
    <!-- META -->
    <meta charset='utf-8' />
    <meta name='viewport' content='initial-scale=1, maximum-scale=1, user-scalable=no' />
    <meta name="format-detection" content="telephone=no">

    <!-- TITLE -->
    <title>Lisboa</title>

    <!-- STYLE SHEETS -->
    <link href='https://fonts.googleapis.com/css?family=Space+Grotesk:300,400,600' rel='stylesheet'>
    <link rel='stylesheet' href='style.css' type='text/css' />

    <!-- MapBox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.4.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
    <!-- HEADER -->
    <div id='header'>
        <!-- HEADER/TITLE -->
        <div id='title'>
            <span class='desktop'>Lisboa&nbsp;Airbnb&nbsp;Explorer</span>
        </div>
    </div>

    <!-- MB Map -->
    <div id='map'></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiY3Jpc2xleW5vIiwiYSI6ImNsanZqc3V5czE3emYzdG4wdnl5emRkOGsifQ.1npueBKtBTbhxx7Wyko1Mw';

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v10',
            center: [-9.1393, 38.7223], // Coordenadas de Lisboa
            zoom: 12,
            pitch: 60, // Ajuste o valor para definir a inclinação 3D adequada
            bearing: 20,
            antialias: true
        });

        // Function to load and process the GeoJSON data
        function loadData() {
            fetch('lisboa.geojson')
                .then(response => response.json())
                .then(data => drawChartBars(data))
                .catch(error => {
                    console.error('Error loading GeoJSON data:', error);
                });
        }

        // Function to group locations based on proximity
        function groupLocations(data) {
            var grouped = new Map();
            var groupDistance = 0.0005; // Adjust this value to control clustering density
            data.features.forEach(feature => {
                var latLng = feature.geometry.coordinates;
                var key = latLng.join(',');
                if (grouped.has(key)) {
                    var group = grouped.get(key);
                    group.count++;
                    grouped.set(key, group);
                } else {
                    grouped.set(key, { coordinates: latLng, count: 1 });
                }
            });

            var clusteredData = [];
            grouped.forEach(group => {
                clusteredData.push({
                    type: 'Feature',
                    properties: { count: group.count },
                    geometry: { type: 'Point', coordinates: group.coordinates }
                });
            });

            return { type: 'FeatureCollection', features: clusteredData };
        }

        // Function to draw chart bars on the map
        function drawChartBars(data) {
            var groupedData = groupLocations(data);
            addBarsToMap(groupedData);
        }

        // Function to add chart bars to the map
        function addBarsToMap(data) {
            map.on('load', function () {
                // Add a new layer for the chart bars
                map.addSource('airbnbData', {
                    type: 'geojson',
                    data: data
                });

                map.addLayer({
                    id: 'bars',
                    type: 'fill-extrusion',
                    source: 'airbnbData',
                    paint: {
                        'fill-extrusion-color': 'green',
                        'fill-extrusion-height': ['*', 5, ['get', 'count']],
                        'fill-extrusion-base': 0,
                        'fill-extrusion-opacity': 0.8,
                        'fill-extrusion-vertical-gradient': true
                    }
                });
            });
        }

        loadData();
    </script>
</body>
</html>
